---
- name: Validação de subscrição - UPFIX 3.4 - Subscription
  hosts: "{{ updatefix_inventory_group_ok }}"
  vars_files:
    - vars/vars.yml
  gather_facts: False
  tasks:
    - name: Coletar fatos do sistema
      ansible.builtin.setup:
        gather_subset:
          - '!all'
          - 'mounts'

    - name: Ler conteúdo do /etc/fstab
      ansible.builtin.slurp:
        src: /etc/fstab
      register: fstab_content

    - name: Decodificar conteúdo do fstab
      set_fact:
        fstab_lines: "{{ (fstab_content['content'] | b64decode).split('\n') }}"

    - name: Verificar se as montagens do fstab estão ativas
      vars:
        active_mounts: "{{ ansible_mounts | map(attribute='mount') | list }}"
      debug:
        msg: "{{ mount_point }} está montado"
      when:
        - mount_point != ''
        - mount_point in active_mounts
      loop: "{{ fstab_lines }}"
      loop_control:
        label: "{{ mount_point }}"
      vars:
        mount_point: "{{ item.split() | first if item.split() | length > 1 else '' }}"
