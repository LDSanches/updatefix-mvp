---
- name: Configuracao base o ambiente de UPDATEFIX
  hosts: localhost
  vars:
    ac_organization: SECURITY #SECURITY #alterar este item 
    ac_cred_ac: CRED-AC-CONFIG
    ac_cred_servers: CRED-SSH-SERVER
    ac_inv_all_hosts: INV-ALL-HOSTS
    ac_inv_updatefix: INV-UPDATEFIX
    ac_proj_updatefix: PROJ-GIT-UPDATEFIX
    ac_hostname: aap01.aroque.com.br #alterar este item
  gather_facts: False
  tasks:

#####################
#### Base do AAP ####
#####################
    - name: Criar inventory UPDATEFIX
      ansible.controller.inventory:
        name: "{{ ac_inv_updatefix }}"
        description: "Inventario de atualização de servidores"
        organization: "{{ ac_organization }}"
        state: present

    - name: Add Automation Controller no inventory de UPDATEFIX
      ansible.controller.host:
        name: "{{ ac_hostname }}"
        inventory: "{{ ac_inv_updatefix }}"
        enabled: True
        variables:
          ansible_connection: local

    - name: Add Grupo AC no inventory UPDATEFIX, add host de AC no grupo
      ansible.controller.group:
        name: AC
        inventory: "{{ ac_inv_updatefix }}"
#        preserve_existing_hosts: True
        hosts: "{{ ac_hostname }}"

######################################
#### Acessibilidade e Inventários ####
######################################

    - name: Criar Job Template de UPFIX 1 - Acessibilidade e Inventários do UPDATEFIX
      ansible.controller.job_template:
        name: UPFIX 1 - PREPARAÇÃO
        job_type: "run"
        organization: "{{ ac_organization }}"
        inventory: "{{ ac_inv_all_hosts }}" # ele usa o inventory full como fonte da verdade
        project: "{{ ac_proj_updatefix }}"
        playbook: "upfix1/upfix1.yml"
        credentials:
          - "{{ ac_cred_ac }}"
        state: "present"
        survey_enabled: yes
        survey_spec: "{{ lookup('file', 'upfix1_survey.json') }}"

##############################
#### Verificações e Ações ####
##############################

    - name: Criar Job Template de UPFIX 2-1 - VERIFICAÇÃO E AÇÃO - TESTE DE PING
      ansible.controller.job_template:
        name: UPFIX 2_1 - ACESSO
        job_type: "run"
        organization: "{{ ac_organization }}"
        inventory: "{{ ac_inv_updatefix }}" # esse job usa o inventory INV-UPDATEFIX
        project: "{{ ac_proj_updatefix }}"
        playbook: "upfix2/upfix2_1.yml"
        credentials:
          - "{{ ac_cred_servers }}" #esse job acessa diretamente os servidores
          - "{{ ac_cred_ac }}"
        state: "present"
        survey_enabled: yes
        survey_spec: "{{ lookup('file', 'upfix_version_survey.json') }}"


##############################
#### Verificações e Ações ####
##############################

    - name: Criar Job Template de UPFIX 2-2 - AJUSTE DE INVENTARIO
      ansible.controller.job_template:
        name: UPFIX 2_2 - INVENTORY
        job_type: "run"
        organization: "{{ ac_organization }}"
        inventory: "{{ ac_inv_updatefix }}" # esse job usa o inventory INV-UPDATEFIX
        project: "{{ ac_proj_updatefix }}"
        playbook: "upfix2/upfix2_2.yml"
        credentials:
          - "{{ ac_cred_servers }}" #esse job acessa diretamente os servidores
          - "{{ ac_cred_ac }}"
        state: "present"
        survey_enabled: yes
        survey_spec: "{{ lookup('file', 'upfix_version_survey.json') }}"


    - name: Criar Job Template de UPFIX 2-3 - VERIFICAÇÃO E AÇÃO - COLETAS e LOGS
      ansible.controller.job_template:
        name: UPFIX 2_3 - LOGS
        job_type: "run"
        organization: "{{ ac_organization }}"
        inventory: "{{ ac_inv_updatefix }}" # esse job usa o inventory INV-UPDATEFIX
        project: "{{ ac_proj_updatefix }}"
        playbook: "upfix2/upfix2_3.yml"
        credentials:
          - "{{ ac_cred_servers }}" #esse job acessa diretamente os servidores
#          - "{{ ac_cred_ac }}"
        state: "present"
        survey_enabled: yes
        survey_spec: "{{ lookup('file', 'upfix_version_survey.json') }}"

############################
#### Seleção e Preparos ####
############################

    - name: Criar Job Template de UPFIX 3-1 - FileSystem Espaço
      ansible.controller.job_template:
        name: UPFIX 3_1 - FILESYSTEM SPACE
        job_type: "run"
        organization: "{{ ac_organization }}"
        inventory: "{{ ac_inv_updatefix }}" # esse job usa o inventory INV-UPDATEFIX
        project: "{{ ac_proj_updatefix }}"
        playbook: "upfix3/upfix3_1.yml"
        credentials:
          - "{{ ac_cred_servers }}" #esse job acessa diretamente os servidores
#          - "{{ ac_cred_ac }}"
        state: "present"
        survey_enabled: yes
        survey_spec: "{{ lookup('file', 'upfix_version_survey.json') }}"

    - name: Criar Job Template de UPFIX 3-2 - FileSystem Somente leitura
      ansible.controller.job_template:
        name: UPFIX 3_2 - FILESYSTEM READONLY
        job_type: "run"
        organization: "{{ ac_organization }}"
        inventory: "{{ ac_inv_updatefix }}" # esse job usa o inventory INV-UPDATEFIX
        project: "{{ ac_proj_updatefix }}"
        playbook: "upfix3/upfix3_2.yml"
        credentials:
          - "{{ ac_cred_servers }}" #esse job acessa diretamente os servidores
#          - "{{ ac_cred_ac }}"
        state: "present"
        survey_enabled: yes
        survey_spec: "{{ lookup('file', 'upfix_version_survey.json') }}"

    - name: Criar Job Template de UPFIX 3-3 - FileSystem Mount Point
      ansible.controller.job_template:
        name: UPFIX 3_3 - FILESYSTEM MOUNT POINT
        job_type: "run"
        organization: "{{ ac_organization }}"
        inventory: "{{ ac_inv_updatefix }}" # esse job usa o inventory INV-UPDATEFIX
        project: "{{ ac_proj_updatefix }}"
        playbook: "upfix3/upfix3_3.yml"
        credentials:
          - "{{ ac_cred_servers }}" #esse job acessa diretamente os servidores
#          - "{{ ac_cred_ac }}"
        state: "present"
        survey_enabled: yes
        survey_spec: "{{ lookup('file', 'upfix_version_survey.json') }}"

    - name: Criar Job Template de UPFIX 3-4 - subscription-manager
      ansible.controller.job_template:
        name: UPFIX 3_4 - SUBSCRIPTION MANAGER
        job_type: "run"
        organization: "{{ ac_organization }}"
        inventory: "{{ ac_inv_updatefix }}" # esse job usa o inventory INV-UPDATEFIX
        project: "{{ ac_proj_updatefix }}"
        playbook: "upfix3/upfix3_4.yml"
        credentials:
          - "{{ ac_cred_servers }}" #esse job acessa diretamente os servidores
#          - "{{ ac_cred_ac }}"
        state: "present"
        survey_enabled: yes
        survey_spec: "{{ lookup('file', 'upfix_version_survey.json') }}"

    - name: Criar Job Template de UPFIX 3-5 - repo
      ansible.controller.job_template:
        name: UPFIX 3_5 - REPOSITORY 
        job_type: "run"
        organization: "{{ ac_organization }}"
        inventory: "{{ ac_inv_updatefix }}" # esse job usa o inventory INV-UPDATEFIX
        project: "{{ ac_proj_updatefix }}"
        playbook: "upfix3/upfix3_5.yml"
        credentials:
          - "{{ ac_cred_servers }}" #esse job acessa diretamente os servidores
#          - "{{ ac_cred_ac }}"
        state: "present"
        survey_enabled: yes
        survey_spec: "{{ lookup('file', 'upfix_version_survey.json') }}"